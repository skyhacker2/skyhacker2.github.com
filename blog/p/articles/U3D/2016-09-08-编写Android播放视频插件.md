# ç¼–å†™Androidæ’­æ”¾è§†é¢‘æ’ä»¶.md

å¦ˆçš„å±…ç„¶æäº†ä¸€ä¸ªæ˜ŸæœŸã€‚

ä¸»è¦éš¾ç‚¹åœ¨äºï¼ŒAndroidé‡Œé¢ï¼Œç”¨æ¥æ’­æ”¾è§†é¢‘çš„Textureæ˜¯`GL_TEXTURE_EXTERNAL_OES`æ ¼å¼çš„ã€‚Unityç”¨çš„Texture`æ˜¯GL_TEXTURE_2D`æ ¼å¼çš„ã€‚ä¸­é—´éœ€è¦è½¬æ¢æ‰å¯ä»¥åœ¨Unityé‡Œé¢æ˜¾ç¤ºï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°çš„æ˜¯Render To Textureï¼Œå°±æ˜¯Frame Buffer Objectå•¦ã€‚

è¦æ˜¾ç¤º`GL_TEXTURE_EXTERNAL_OES`ï¼Œéœ€è¦ç‰¹åˆ«çš„shader

VertexShader

```
attribute vec4 aPosition;
attribute mediump vec2 aTextureCoord;
varying mediump vec2 vTextureCoord;
uniform mat4 uMVPMatrix;

void main() {
  gl_Position = uMVPMatrix * aPosition;
  vTextureCoord = aTextureCoord.xy;
}
```

FragmentShader

```
#extension GL_OES_EGL_image_external : require

precision mediump float;

varying vec2 vTextureCoord;
uniform samplerExternalOES sTexture;

void main() {
  gl_FragColor = texture2D(sTexture, vTextureCoord);
}
```

## æ–°å»ºä¸€ä¸ªFBOå¯¹è±¡ï¼š

```java
public class FBO {
    private Texture2D mTexture2D;
    private int mFBOID;
    private int mRBOID;

    public FBO(Texture2D texture2D) {
        mTexture2D = texture2D;
        int depthID;
        int[] temps = new int[1];
        // Render buffer
        GLES20.glGenTextures(1, temps, 0);
        depthID = temps[0];
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, temps[0]);
        GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, 0, GLES20.GL_DEPTH_COMPONENT, texture2D.getWidth(), texture2D.getHeight(), 0, GLES20.GL_DEPTH_COMPONENT, GLES20.GL_UNSIGNED_SHORT, null);
        GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_NEAREST);
        GLES20.glTexParameterf(GLES20.GL_TEXTURE_2D,
                GLES20.GL_TEXTURE_MAG_FILTER,
                GLES20.GL_LINEAR);

        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S,
                GLES20.GL_CLAMP_TO_EDGE);
        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T,
                GLES20.GL_CLAMP_TO_EDGE);
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, 0);

        GLES20.glGenFramebuffers(1, temps, 0);
        mFBOID = temps[0];
        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, mFBOID);
        GLES20.glFramebufferTexture2D(GLES20.GL_FRAMEBUFFER, GLES20.GL_COLOR_ATTACHMENT0, GLES20.GL_TEXTURE_2D, mTexture2D.getTextureID(), 0);
        GLES20.glFramebufferTexture2D(GLES20.GL_FRAMEBUFFER, GLES20.GL_DEPTH_ATTACHMENT, GLES20.GL_TEXTURE_2D, depthID, 0);

        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, 0);


    }

    public void FBOBegin() {
        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, mFBOID);

        GLES20.glBindBuffer(GLES20.GL_ELEMENT_ARRAY_BUFFER, 0);
        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, 0);
        Utils.checkGlError("glBindBuffer GL_ARRAY_BUFFER 0");

    }

    public void FBOEnd() {
        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, 0);
    }
```

æˆ‘è¿™é‡Œå°è£…äº†ä¸€ä¸ªTexture2Dçš„Javaå¯¹è±¡ï¼Œé‡Œé¢å†™äº†ä¸€äº›é€šç”¨çš„æ–¹æ³•ï¼Œä¾‹å¦‚loadShaderã€åˆ›å»ºprogramå’Œdrawã€‚

## åˆ›å»ºGL_TEXTURE_EXTERNAL_OESè´´å›¾

```java
int[] temps = new int[1];
GLES20.glGenTextures(1, temps, 0);
mTextureID = temps[0];
GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, mTextureID);
Utils.checkGlError("glBindTexture mTextureID");

GLES20.glTexParameterf(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_MIN_FILTER,
        GLES20.GL_NEAREST);
GLES20.glTexParameterf(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_MAG_FILTER,
        GLES20.GL_LINEAR);

GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S,
        GLES20.GL_CLAMP_TO_EDGE);
GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T,
        GLES20.GL_CLAMP_TO_EDGE);
```

ç„¶åæŠŠè¿™å¼ è´´å›¾ä¼ ç»™SurfaceTexture

```
mTexture2DExt = new Texture2DExt(UnityPlayer.currentActivity, 0,0);
mSurfaceTexture = new SurfaceTexture(mTexture2DExt.getTextureID());
```

Texture2DExtæ˜¯ç»§æ‰¿Texture2Dçš„æ”¯æŒGL_TEXTURE_EXTERNAL_OESæ ¼å¼çš„è´´å›¾ã€‚

## æ›´æ–°è´´å›¾

```
public int updateTexture() {
    synchronized (this) {
        if (mFrameUpdated) {
            mSurfaceTexture.updateTexImage();
        }
        mFrameUpdated = false;
        if (mUnityTexture == null) {
            mUnityTexture = new Texture2D(UnityPlayer.currentActivity, getVideoWidth(), getVideoHeight());
            mFBO = new FBO(mUnityTexture);
        }
    }
    if (mIjkMediaPlayer != null) {
        if (mState == STATE_PLAYING || mState == STATE_PAUSEED) {
//                float[] mat = new float[16];
//                mSurfaceTexture.getTransformMatrix(mat);

            Matrix.setIdentityM(mMVPMatrix, 0);
            mFBO.FBOBegin();
            GLES20.glViewport(0, 0, mIjkMediaPlayer.getVideoWidth(), mIjkMediaPlayer.getVideoHeight());
            mTexture2DExt.draw(mMVPMatrix);
            mFBO.FBOEnd();
            Point size = new Point();
            UnityPlayer.currentActivity.getWindowManager().getDefaultDisplay().getSize(size);
            GLES20.glViewport(0,0,size.x,size.y);
        }

        return mUnityTexture.getTextureID();
    }
    return 0;
}
```

mTexture2DExt.drawçš„drawæ–¹æ³•ä»£ç ï¼š

```
//        Log.d(TAG, "draw");
        GLES20.glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
        Utils.checkGlError("glClearColor1");
        GLES20.glClear(GLES20.GL_DEPTH_BUFFER_BIT | GLES20.GL_COLOR_BUFFER_BIT);
        Utils.checkGlError("glClearColor2");
        GLES20.glUseProgram(mProgram);
        
        // ä¸€ç‚¹è¦åŠ è¿™ä¸¤è¡Œï¼Œä¸ç„¶ä¼šå‡ºç°OUF OF MEMORYé”™è¯¯
        // http://forum.unity3d.com/threads/mixing-unity-with-native-opengl-drawing-on-android.134621/
        GLES20.glBindBuffer(GLES20.GL_ELEMENT_ARRAY_BUFFER, 0);
        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, 0);

//        GLES20.glDisable(GLES20.GL_DEPTH_TEST);
//
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0);
        GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, mTextureID);
        int positionHandle = GLES20.glGetAttribLocation(mProgram, "aPosition");
        Utils.checkGlError("glGetAttribLocation aPosition");

        // Enable a handle to the triangle vertices
        GLES20.glEnableVertexAttribArray(positionHandle);

        // Prepare the triangle coordinate data
        GLES20.glVertexAttribPointer(
                positionHandle, COORDS_PER_VERTEX,
                GLES20.GL_FLOAT, false,
                vertexStride, vertexBuffer);

        Assert.assertNotNull(vertexBuffer);
//
        int maTextureHandle = GLES20.glGetAttribLocation(mProgram, "aTextureCoord");
        GLES20.glVertexAttribPointer(
                maTextureHandle, 2,
                GLES20.GL_FLOAT, false,
                0, uvBuffer);

        Assert.assertNotNull(uvBuffer);

        GLES20.glEnableVertexAttribArray(maTextureHandle);
//
        int mSamplerLoc = GLES20.glGetUniformLocation (mProgram,  "sTexture" );
        GLES20.glUniform1i(mSamplerLoc, 0);
//
        int mvpMatrixHandle = GLES20.glGetUniformLocation(mProgram, "uMVPMatrix");
//
//        // Pass the projection and view transformation to the shader
        GLES20.glUniformMatrix4fv(mvpMatrixHandle, 1, false, mvpMatrix, 0);
//        // Draw the square
        GLES20.glDrawElements(
                GLES20.GL_TRIANGLES, drawOrder.length,
                GLES20.GL_UNSIGNED_SHORT, drawListBuffer);
        Assert.assertNotNull(drawOrder);
        Assert.assertNotNull(drawListBuffer);
        Utils.checkGlError("glDrawElements");
        
        GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, 0);
```

è¿™ä¸ªæ–¹å¼æ˜¯ç”¨æ¥æ›´æ–°è´´å›¾çš„ï¼Œé¦–å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰`mUnityTexture`ï¼Œè¿™æ˜¯Unityé‡Œé¢ç”¨æ¥æ˜¾ç¤ºçš„è´´å›¾ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€å¼ è·Ÿè§†é¢‘å¤§å°ä¸€æ ·çš„è´´å›¾ï¼Œä¼ ç»™FBOå¯¹è±¡ã€‚

è¿™é‡Œé‡åˆ°ä¸€ä¸ªå‘å°±æ˜¯ï¼Œå¦‚æœåœ¨glDrawElementsæˆ–glDrawArraysåè°ƒç”¨ä»¥ä¸‹çš„æ–¹æ³•ï¼š

```java
GLES20.glDisableVertexAttribArray(positionHandle);
GLES20.glDisableVertexAttribArray(maTextureHandle);
```

é‚£ä¹ˆå°±ä¼šå‡ºç°`validate_vertex_attrib_state: no vertex attrib is enabled in a draw call!`é”™è¯¯ï¼ï¼ï¼

æ­£å¸¸æ¥è¯´æ˜¯è¦è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯åœ¨unityé‡Œé¢ä¸èƒ½è°ƒç”¨ã€‚

è¿˜æœ‰å°±æ˜¯è¦æ”¹å˜Viewportè·å–åˆ°æ­£ç¡®å¤§å°çš„è´´å›¾ï¼Œç„¶åå†é‡è®¾Viewportå›å±å¹•å¤§å°ã€‚ 

è¿™æ—¶å€™Androidè¿™è¾¹çš„å®ç°å¥½äº†ã€‚å†çœ‹Unityé‡Œé¢ã€‚

```
if (Native_IsFrameUpdated ()) {
    int textureId = Native_UpdateTexture ();

    if (texture == null) {
        texture = Texture2D.CreateExternalTexture (1, 1, TextureFormat.RGB565, false, false, (IntPtr)textureId);
        texture.wrapMode = TextureWrapMode.Clamp;
        texture.filterMode = FilterMode.Bilinear;
    } else {
        texture.UpdateExternalTexture ((IntPtr)textureId);
    }

    if (GetComponent<RawImage> () != null) {
        GetComponent<RawImage> ().texture = texture;
    } else {
        GetComponent<Renderer> ().material.mainTexture = texture;
    }

}
```

é€šè¿‡`CreateExternalTexture`åˆ›å»ºä¸€å¼ å¤–éƒ¨çº¹ç†ï¼Œå°±æ˜¯åˆšæ‰ä¸Šé¢é‚£ä¸ªæ–¹æ³•è¿”å›çš„`mUnityTexture.getTextureID();`ã€‚

OKï¼Œå¯ä»¥åœ¨Unityé‡Œé¢æ’­è§†é¢‘äº†ï¼å‰©ä¸‹è¿˜æœ‰å¾ˆå¤šç»†èŠ‚çš„ä¸œè¥¿æ…¢æ…¢æäº†ã€‚ğŸ˜‚ğŸ˜‚ğŸ˜‚

 ![Screenshot_2016-09-08-19-56-46-618_com.ihunuo.unity.test.jlvideo](images/Screenshot_2016-09-08-19-56-46-618_com.ihunuo.unity.test.jlvideo.png)

## Reference

[http://www.songho.ca/opengl/gl_fbo.html](http://www.songho.ca/opengl/gl_fbo.html)

[http://forum.unity3d.com/threads/mixing-unity-with-native-opengl-drawing-on-android.134621/](http://forum.unity3d.com/threads/mixing-unity-with-native-opengl-drawing-on-android.134621/)



